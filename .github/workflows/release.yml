name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest

    steps:
      - name: Checkout plumise-agent-app
        uses: actions/checkout@v4

      - name: Download llama-server (CUDA 12.4)
        run: |
          $ver = "b5200"
          $url = "https://github.com/ggerganov/llama.cpp/releases/download/$ver/llama-$ver-bin-win-cuda-cu12.4-x64.zip"
          Write-Host "Downloading llama-server $ver..."
          Invoke-WebRequest -Uri $url -OutFile llama.zip
          Expand-Archive llama.zip -DestinationPath llama-bin

          New-Item -Path "src-tauri/binaries" -ItemType Directory -Force

          # Copy llama-server binary (Tauri sidecar naming convention)
          Copy-Item "llama-bin/build/bin/llama-server.exe" "src-tauri/binaries/llama-server-x86_64-pc-windows-msvc.exe"

          # Copy CUDA DLLs (bundled as resources)
          Get-ChildItem "llama-bin/build/bin/*.dll" | ForEach-Object {
            Copy-Item $_.FullName "src-tauri/binaries/"
            Write-Host "  Bundled: $($_.Name)"
          }

          $sizeMB = [math]::Round((Get-Item "src-tauri/binaries/llama-server-x86_64-pc-windows-msvc.exe").Length / 1MB)
          Write-Host "llama-server binary: $sizeMB MB"
          $dllCount = (Get-ChildItem "src-tauri/binaries/*.dll").Count
          Write-Host "DLLs bundled: $dllCount"
        shell: pwsh

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Node dependencies
        run: npm install

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> target

      - name: Build Tauri app
        run: npx tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ''

      - name: List build artifacts
        run: |
          Get-ChildItem -Recurse "src-tauri/target/release/bundle" | Select-Object FullName
        shell: pwsh

      - name: Generate updater latest.json
        run: |
          $version = (Get-Content src-tauri/tauri.conf.json | ConvertFrom-Json).version
          $msiZip = Get-ChildItem "src-tauri/target/release/bundle/msi/*.msi.zip" | Select-Object -First 1
          $sigFile = Get-ChildItem "src-tauri/target/release/bundle/msi/*.msi.zip.sig" | Select-Object -First 1
          $signature = Get-Content $sigFile.FullName -Raw
          $tag = "v$version"
          $url = "https://github.com/mikusnuz/plumise-agent-app/releases/download/$tag/$($msiZip.Name)"
          $json = @{
            version = $version
            notes = "See release notes on GitHub"
            pub_date = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
            platforms = @{
              "windows-x86_64" = @{
                signature = $signature.Trim()
                url = $url
              }
            }
          } | ConvertTo-Json -Depth 4
          $json | Out-File -FilePath "src-tauri/target/release/bundle/msi/latest.json" -Encoding utf8
          Write-Host "Generated latest.json for $tag"
          Write-Host $json
        shell: pwsh

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/msi/*.msi.zip
            src-tauri/target/release/bundle/msi/*.msi.zip.sig
            src-tauri/target/release/bundle/msi/latest.json
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
