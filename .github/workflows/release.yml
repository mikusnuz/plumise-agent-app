name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest

    steps:
      - name: Checkout plumise-agent-app
        uses: actions/checkout@v4

      - name: Download llama-server (CUDA 12.4)
        run: |
          $ver = "b8022"
          $base = "https://github.com/ggml-org/llama.cpp/releases/download/$ver"

          # Download main binary package
          Write-Host "Downloading llama-server $ver..."
          Invoke-WebRequest -Uri "$base/llama-$ver-bin-win-cuda-12.4-x64.zip" -OutFile llama.zip

          # Download CUDA runtime DLLs (separate package)
          Write-Host "Downloading CUDA runtime DLLs..."
          Invoke-WebRequest -Uri "$base/cudart-llama-bin-win-cuda-12.4-x64.zip" -OutFile cudart.zip

          # Extract both
          Expand-Archive llama.zip -DestinationPath llama-bin
          Expand-Archive cudart.zip -DestinationPath cudart-bin

          # Debug: show extracted structure
          Write-Host "=== llama-bin contents ==="
          Get-ChildItem -Recurse llama-bin -File | Select-Object -First 30 FullName

          New-Item -Path "src-tauri/binaries" -ItemType Directory -Force

          # Find and copy llama-server.exe (search recursively)
          $serverExe = Get-ChildItem -Recurse llama-bin -Filter "llama-server.exe" | Select-Object -First 1
          if (-not $serverExe) {
            Write-Error "llama-server.exe not found in extracted archive!"
            exit 1
          }
          Copy-Item $serverExe.FullName "src-tauri/binaries/llama-server-x86_64-pc-windows-msvc.exe"
          Write-Host "Found llama-server at: $($serverExe.FullName)"

          # Copy all DLLs to src-tauri/ root (NOT binaries/ subdirectory!)
          # Tauri places sidecar in install root, resources preserve dir structure.
          # By putting DLLs in src-tauri/ with resources: ["*.dll"], they end up
          # in the same directory as the sidecar exe. llama-server finds them automatically.
          $serverDir = $serverExe.DirectoryName
          Get-ChildItem "$serverDir/*.dll" | ForEach-Object {
            Copy-Item $_.FullName "src-tauri/"
            Write-Host "  Bundled: $($_.Name)"
          }

          # Copy CUDA runtime DLLs (cublas, cublasLt, cudart)
          Get-ChildItem -Recurse cudart-bin -Filter "*.dll" | ForEach-Object {
            Copy-Item $_.FullName "src-tauri/"
            Write-Host "  Bundled (cudart): $($_.Name)"
          }

          $sizeMB = [math]::Round((Get-Item "src-tauri/binaries/llama-server-x86_64-pc-windows-msvc.exe").Length / 1MB)
          Write-Host "llama-server binary: $sizeMB MB"
          $dllCount = (Get-ChildItem "src-tauri/*.dll").Count
          Write-Host "DLLs bundled (in src-tauri root): $dllCount"
          Get-ChildItem "src-tauri/*.dll" | ForEach-Object { Write-Host "  $_" }
        shell: pwsh

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Node dependencies
        run: npm install

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> target

      - name: Build Tauri app
        run: npx tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ''
          # Override resources to bundle DLLs from src-tauri/ root (next to sidecar exe in install dir)
          TAURI_CONFIG: '{"bundle":{"resources":["*.dll"]}}'

      - name: List build artifacts
        run: |
          Get-ChildItem -Recurse "src-tauri/target/release/bundle" | Select-Object FullName
        shell: pwsh

      - name: Generate updater latest.json
        run: |
          $ErrorActionPreference = "Stop"
          $version = (Get-Content src-tauri/tauri.conf.json | ConvertFrom-Json).version
          $tag = "v$version"

          # Debug: list all bundle files
          Write-Host "=== Bundle directory contents ==="
          Get-ChildItem -Recurse "src-tauri/target/release/bundle" -File | ForEach-Object {
            Write-Host "  $($_.FullName) ($([math]::Round($_.Length / 1MB, 1)) MB)"
          }

          # Find .msi.zip and .sig (Tauri v2 updater artifacts)
          $msiZip = Get-ChildItem -Recurse "src-tauri/target/release/bundle" -Filter "*.msi.zip" | Select-Object -First 1
          if (-not $msiZip) {
            Write-Host "WARNING: No .msi.zip found, looking for .msi to create latest.json"
            $msi = Get-ChildItem -Recurse "src-tauri/target/release/bundle" -Filter "*.msi" | Select-Object -First 1
            if (-not $msi) {
              Write-Error "No MSI artifacts found!"
              exit 1
            }
            # Create latest.json without updater signature (manual update only)
            $url = "https://github.com/mikusnuz/plumise-agent-app/releases/download/$tag/$($msi.Name)"
            $json = @{
              version = $version
              notes = "See release notes on GitHub"
              pub_date = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
              platforms = @{
                "windows-x86_64" = @{
                  url = $url
                }
              }
            } | ConvertTo-Json -Depth 4
            $json | Out-File -FilePath "$($msi.DirectoryName)/latest.json" -Encoding utf8
            Write-Host "Generated latest.json (no signature) for $tag"
            Write-Host $json
            exit 0
          }

          $sigFile = Get-ChildItem -Recurse "src-tauri/target/release/bundle" -Filter "*.msi.zip.sig" | Select-Object -First 1
          if (-not $sigFile) {
            Write-Error "Found .msi.zip but no .msi.zip.sig â€” check TAURI_SIGNING_PRIVATE_KEY"
            exit 1
          }

          $signature = Get-Content $sigFile.FullName -Raw
          $url = "https://github.com/mikusnuz/plumise-agent-app/releases/download/$tag/$($msiZip.Name)"
          $json = @{
            version = $version
            notes = "See release notes on GitHub"
            pub_date = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
            platforms = @{
              "windows-x86_64" = @{
                signature = $signature.Trim()
                url = $url
              }
            }
          } | ConvertTo-Json -Depth 4
          $json | Out-File -FilePath "$($msiZip.DirectoryName)/latest.json" -Encoding utf8
          Write-Host "Generated latest.json for $tag"
          Write-Host $json
        shell: pwsh

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            src-tauri/target/release/bundle/**/*.msi
            src-tauri/target/release/bundle/**/*.msi.zip
            src-tauri/target/release/bundle/**/*.msi.zip.sig
            src-tauri/target/release/bundle/**/latest.json
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
