name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download llama-server (CUDA 12.4)
        run: |
          $ver = "b8022"
          $base = "https://github.com/ggml-org/llama.cpp/releases/download/$ver"

          Write-Host "Downloading llama-server $ver (CUDA 12.4)..."
          Invoke-WebRequest -Uri "$base/llama-$ver-bin-win-cuda-12.4-x64.zip" -OutFile llama.zip

          Write-Host "Downloading CUDA runtime DLLs..."
          Invoke-WebRequest -Uri "$base/cudart-llama-bin-win-cuda-12.4-x64.zip" -OutFile cudart.zip

          Expand-Archive llama.zip -DestinationPath llama-bin
          Expand-Archive cudart.zip -DestinationPath cudart-bin

          New-Item -Path "src-tauri/binaries" -ItemType Directory -Force

          $serverExe = Get-ChildItem -Recurse llama-bin -Filter "llama-server.exe" | Select-Object -First 1
          if (-not $serverExe) {
            Write-Error "llama-server.exe not found!"
            exit 1
          }
          Copy-Item $serverExe.FullName "src-tauri/binaries/llama-server-x86_64-pc-windows-msvc.exe"
          Write-Host "llama-server: $($serverExe.FullName)"

          # rpc-server for distributed inference
          $rpcExe = Get-ChildItem -Recurse llama-bin -Filter "rpc-server.exe" | Select-Object -First 1
          if (-not $rpcExe) {
            Write-Error "rpc-server.exe not found!"
            exit 1
          }
          Copy-Item $rpcExe.FullName "src-tauri/binaries/rpc-server-x86_64-pc-windows-msvc.exe"
          Write-Host "rpc-server: $($rpcExe.FullName)"

          # Copy DLLs to src-tauri/ root (bundled as resources next to sidecar)
          $serverDir = $serverExe.DirectoryName
          Get-ChildItem "$serverDir/*.dll" | ForEach-Object {
            Copy-Item $_.FullName "src-tauri/"
            Write-Host "  DLL: $($_.Name)"
          }
          Get-ChildItem -Recurse cudart-bin -Filter "*.dll" | ForEach-Object {
            Copy-Item $_.FullName "src-tauri/"
            Write-Host "  DLL (cudart): $($_.Name)"
          }

          $sizeMB = [math]::Round((Get-Item "src-tauri/binaries/llama-server-x86_64-pc-windows-msvc.exe").Length / 1MB)
          Write-Host "Binary: $sizeMB MB, DLLs: $((Get-ChildItem 'src-tauri/*.dll').Count)"
        shell: pwsh

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> target

      - name: Build Tauri (Windows MSI)
        run: npx tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ''
          TAURI_CONFIG: '{"bundle":{"resources":["*.dll"]}}'

      - name: Collect Windows artifacts
        run: |
          Write-Host "=== Bundle directory ==="
          Get-ChildItem -Recurse "src-tauri/target/release/bundle" -File | ForEach-Object {
            Write-Host "  $($_.FullName) ($([math]::Round($_.Length / 1MB, 1)) MB)"
          }

          New-Item -Path "artifacts" -ItemType Directory -Force
          Get-ChildItem -Recurse "src-tauri/target/release/bundle" -Filter "*.msi" | Copy-Item -Destination "artifacts/"
          Get-ChildItem -Recurse "src-tauri/target/release/bundle" -Filter "*.msi.zip" | Copy-Item -Destination "artifacts/"
          Get-ChildItem -Recurse "src-tauri/target/release/bundle" -Filter "*.msi.zip.sig" | Copy-Item -Destination "artifacts/"

          Write-Host "=== Collected artifacts ==="
          Get-ChildItem "artifacts" | ForEach-Object { Write-Host "  $($_.Name) ($([math]::Round($_.Length / 1MB, 1)) MB)" }
        shell: pwsh

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-bundle
          path: artifacts/*

  build-macos:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download llama-server (macOS ARM64 Metal)
        run: |
          ver="b8022"
          base="https://github.com/ggml-org/llama.cpp/releases/download/$ver"

          echo "Downloading llama-server $ver (macOS ARM64)..."
          curl -L -o llama.tar.gz "$base/llama-$ver-bin-macos-arm64.tar.gz"
          mkdir -p llama-bin
          tar xzf llama.tar.gz -C llama-bin

          echo "=== Extracted contents ==="
          find llama-bin -type f | head -20

          mkdir -p src-tauri/binaries

          # Find llama-server binary
          SERVER_BIN=$(find llama-bin -name "llama-server" -type f | head -1)
          if [ -z "$SERVER_BIN" ]; then
            echo "ERROR: llama-server not found!"
            exit 1
          fi
          cp "$SERVER_BIN" src-tauri/binaries/llama-server-aarch64-apple-darwin
          chmod +x src-tauri/binaries/llama-server-aarch64-apple-darwin

          SIZE_MB=$(du -m "src-tauri/binaries/llama-server-aarch64-apple-darwin" | cut -f1)
          echo "llama-server: $SIZE_MB MB"

          # rpc-server for distributed inference
          RPC_BIN=$(find llama-bin -name "rpc-server" -type f | head -1)
          if [ -z "$RPC_BIN" ]; then
            echo "ERROR: rpc-server not found!"
            exit 1
          fi
          cp "$RPC_BIN" src-tauri/binaries/rpc-server-aarch64-apple-darwin
          chmod +x src-tauri/binaries/rpc-server-aarch64-apple-darwin
          echo "rpc-server: $(du -m src-tauri/binaries/rpc-server-aarch64-apple-darwin | cut -f1) MB"

          # Copy dylibs with short names (e.g., libmtmd.0.dylib) by following symlinks
          echo "Copying dylibs..."
          LLAMA_DIR=$(find llama-bin -name "llama-server" -type f -exec dirname {} \;)
          for dylib in $(find "$LLAMA_DIR" -name "lib*.0.dylib" -type l 2>/dev/null); do
            cp -L "$dylib" src-tauri/
            echo "  Bundled: $(basename $dylib) ($(du -h "src-tauri/$(basename $dylib)" | cut -f1))"
          done

          # Also add Resources rpath to llama-server for Tauri resource bundling
          install_name_tool -add_rpath @loader_path/../Resources \
            src-tauri/binaries/llama-server-aarch64-apple-darwin

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> target

      - name: Build Tauri (macOS App)
        run: npx tauri build --verbose --bundles app
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ''
          APPLE_SIGNING_IDENTITY: '-'

      - name: Bundle dylibs and create DMG
        run: |
          set -e
          VERSION=$(jq -r '.version' src-tauri/tauri.conf.json)

          echo "=== Searching for .app bundle ==="
          APP_PATH=$(find src-tauri/target -name "*.app" -type d | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "ERROR: .app bundle not found!"
            find src-tauri/target -maxdepth 5 -type d 2>/dev/null | head -40
            exit 1
          fi
          echo "Found app: $APP_PATH"

          # Copy dylibs into .app bundle (Resources dir â€” matched by @loader_path/../Resources rpath)
          echo "=== Copying dylibs into bundle ==="
          for dylib in src-tauri/lib*.dylib; do
            cp "$dylib" "$APP_PATH/Contents/Resources/"
            echo "  $(basename $dylib)"
          done
          echo "Resources contents:"
          ls -lh "$APP_PATH/Contents/Resources/"

          # Re-sign after modification (ad-hoc)
          codesign --force --deep --sign - "$APP_PATH"
          codesign -dvv "$APP_PATH" 2>&1 || true

          # Create clean DMG with ONLY the .app
          mkdir -p dmg-staging artifacts
          cp -R "$APP_PATH" dmg-staging/
          hdiutil create \
            -volname "Plumise Agent" \
            -srcfolder dmg-staging \
            -ov -format UDZO \
            "artifacts/Plumise-Agent_${VERSION}_aarch64.dmg"

          echo "DMG created: $(ls -lh artifacts/*.dmg)"

          # Collect updater artifacts (.tar.gz + .sig)
          find src-tauri/target -name "*.app.tar.gz" ! -name "*.sig" -type f -exec cp {} artifacts/ \;
          find src-tauri/target -name "*.app.tar.gz.sig" -type f -exec cp {} artifacts/ \;

          echo "=== Collected artifacts ==="
          ls -lh artifacts/

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-bundle
          path: artifacts/*

  release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (for version)
        uses: actions/checkout@v4

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-bundle
          path: artifacts/windows

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-bundle
          path: artifacts/macos

      - name: Debug artifact structure
        run: find artifacts -type f -exec ls -lh {} \;

      - name: Generate updater latest.json
        run: |
          set -e
          VERSION=$(jq -r '.version' src-tauri/tauri.conf.json)
          TAG="v$VERSION"
          REPO="mikusnuz/plumise-agent-app"
          BASE_URL="https://github.com/$REPO/releases/download/$TAG"

          echo "Version: $VERSION, Tag: $TAG"

          # Find Windows updater artifacts
          WIN_ZIP=$(find artifacts/windows -name "*.msi.zip" | head -1)
          WIN_SIG=$(find artifacts/windows -name "*.msi.zip.sig" | head -1)

          # Find macOS updater artifacts
          MAC_TAR=$(find artifacts/macos -name "*.tar.gz" ! -name "*.sig" | head -1)
          MAC_SIG=$(find artifacts/macos -name "*.tar.gz.sig" | head -1)

          echo "Windows zip: $WIN_ZIP"
          echo "Windows sig: $WIN_SIG"
          echo "macOS tar: $MAC_TAR"
          echo "macOS sig: $MAC_SIG"

          # Build platforms JSON
          PLATFORMS="{}"

          if [ -n "$WIN_ZIP" ] && [ -n "$WIN_SIG" ]; then
            WIN_SIG_CONTENT=$(cat "$WIN_SIG" | tr -d '\n')
            WIN_FILENAME=$(basename "$WIN_ZIP")
            PLATFORMS=$(echo "$PLATFORMS" | jq \
              --arg sig "$WIN_SIG_CONTENT" \
              --arg url "$BASE_URL/$WIN_FILENAME" \
              '. + {"windows-x86_64": {"signature": $sig, "url": $url}}')
          fi

          if [ -n "$MAC_TAR" ] && [ -n "$MAC_SIG" ]; then
            MAC_SIG_CONTENT=$(cat "$MAC_SIG" | tr -d '\n')
            MAC_FILENAME=$(basename "$MAC_TAR")
            PLATFORMS=$(echo "$PLATFORMS" | jq \
              --arg sig "$MAC_SIG_CONTENT" \
              --arg url "$BASE_URL/$MAC_FILENAME" \
              '. + {"darwin-aarch64": {"signature": $sig, "url": $url}}')
          fi

          # Build final latest.json
          jq -n \
            --arg version "$VERSION" \
            --arg pub_date "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --argjson platforms "$PLATFORMS" \
            '{version: $version, notes: "See release notes on GitHub", pub_date: $pub_date, platforms: $platforms}' \
            > artifacts/latest.json

          echo "=== latest.json ==="
          cat artifacts/latest.json

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/windows/*
            artifacts/macos/*
            artifacts/latest.json
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
